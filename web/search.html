<style>
body { font-family: 'Open Sans', 'lucida grande', sans-serif; font-size:13px; margin:10px 15%; }
div { padding-bottom:16px }
a, a:hover { color:#557799 }

#searchBox { padding: 30px 0 20px }
#searchText { width:200px }
#more { cursor:pointer; display:none }
dt { padding-top:16px; color:#557799; font-weight:bold }
dd { color:#333; font-size:12px; max-width:500px; margin-left:23px; line-height:16px }
dd em { font-weight: bold; font-style: normal; background: #ffa }
.icon { margin-right: 6px; vertical-align: -4px; width:16px;height:16px }
.path { color: #009933; white-space:nowrap; text-overflow: ellipsis; overflow: hidden; }
.date { color: #666666 }
</style>

<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0">

<title>Dropbox Search</title>

<div id="searchBox">
    <input type="search" name="q" id="searchText"/>
    <input type="submit" id="search" value="search"/>
</div>

<div id="results">
</div>

<div id="more"><a><span id="count"></span> More &raquo;</a></div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>

<script>
    var resultCount = 0;
    var nextResult = 0;
    $("#searchText").keyup(function(event) {
        if (event.keyCode == 13) {
            newSearch($(event.target).attr("value"));
        }
    });
    $("#searchText").select();
    $("#search").click(function() { newSearch($("#searchText").attr("value")) });
    $("#more").click(showMore);
    
    function doSearch(text, start) {
        jQuery.ajax( {
            url: "/find?q=" + encodeURIComponent(text) + "&start=" + start,
            dataType: "json",
            async: false,
            success: function(data) {
                showResults(data);
            },
            error: function(err) {
                $("#results").html("").append("<dt>No results found (invalid search).</dt><dd>" + JSON.stringify(err) + "</dd>");
            }
        } );
    }
    
    function newSearch(text) {
        doSearch(text, 0);
    
        history.pushState({text : text}, null, "?q=" + encodeURIComponent(text));
    }
    
    window.onpopstate = function(event) {
        var text = event.state ? event.state.text : (window.location.search.indexOf('?q=') === 0 ? decodeURIComponent(window.location.search.substring(3)) : "");
        $("#searchText").attr("value", text);
        if (text) {
            doSearch(text, 0); // don't call pushState
            $("#searchText").select();
        } else {
            $("#results").html("");
        }
    };
    
    function showResults(results) {
        resultCount = results.response.numFound;
        nextResult = results.response.start + 10;
        var resultsDiv = $("#results");
        
        if (resultCount > nextResult) {
            $("#count").html(resultCount - nextResult);
            $("#more").show();
        } else {
            $("#more").hide();
        }
        
        if (results.response.start === 0) {
            resultsDiv.html("");
        }
        if (resultCount === 0) {
            resultsDiv.append("<dt>No results found.</dt>");
        }
        var scrollPos = resultsDiv.offset().top + resultsDiv.height();
        if (scrollPos > $("body").scrollTop()) {
            $("body").animate({ scrollTop: scrollPos }, 600);
        }
        
        for (var doc in results.response.docs) {
            var result = results.response.docs[doc];
            var hilight = results.highlighting[result.id];
            var title;
            if (result.title) { // title array may have blank elements so skip those
                for (var i = 0; i < result.title.length; i++) {
                    if (result.title[i] && result.title[i].trim()) {
                        title = result.title[i];
                        break;
                    }
                }
            }
            else {
                title = result.path;
            }
            var icon = "<img src='/icons/" + result.icon + ".gif' class='icon'>";
            resultsDiv.append("<dt>" + icon + title + "</dt>");
            resultsDiv.append("<dd class='path'>" + formatPath(result.path) + "</dd>");
            var snippet = "<dd>" + formatDate(result.when);
            for (var h in hilight) {
                snippet +=  " &mdash; " + hilight[h][0] + "</dd>";
                break; // show first only
            }
            resultsDiv.append(snippet);
        }
    }
    
    function showMore() {
        doSearch($("#searchText").attr("value"), nextResult);
    }
    
    function formatPath(path) {
        return (path.lastIndexOf("/") === 0 || path.length <= 1) ? path : path.substring(1);
    }
    
    function formatDate(date) {
        var dd = new Date(date);
        return "<span class='date'>" + months[dd.getMonth()] + " " + dd.getDate() + ", " + dd.getFullYear() + "</span>";
    }
    
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
</script>
